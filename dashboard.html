<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API TESTER | Wasi OTP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .blue-grad { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 bg-white p-8 rounded-[2.5rem] shadow-xl shadow-blue-100 border border-blue-50">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-3xl font-black text-blue-700 uppercase tracking-tighter">Testing <span class="text-slate-800">Mode</span></h1>
                <p class="text-xs font-black text-red-500 uppercase tracking-widest mt-1"><i class="fa-solid fa-unlock mr-1"></i> Firebase Bypassed for Testing</p>
            </div>
            <div class="bg-blue-50 px-8 py-4 rounded-3xl border border-blue-100 text-center">
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Demo Balance</p>
                <p class="text-3xl font-black text-green-600">RS 5000.00</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Side: Selection (40%) -->
            <div class="lg:col-span-5 space-y-6">
                <!-- Server Selection -->
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-blue-100">
                    <label class="block text-xs font-black text-blue-700 uppercase mb-4 tracking-widest">1. Select Country Server</label>
                    <select id="countrySelect" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 font-bold text-slate-700 outline-none focus:border-blue-500 transition-all cursor-pointer">
                        <option value="">ðŸ”„ Loading Countries...</option>
                    </select>
                </div>

                <!-- Service Selection -->
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-blue-100">
                    <label class="block text-xs font-black text-blue-700 uppercase mb-4 tracking-widest">2. Select Service</label>
                    <select id="serviceSelect" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 font-bold text-slate-700 outline-none focus:border-blue-500 transition-all cursor-pointer">
                        <option value="">Choose Country First</option>
                    </select>
                </div>

                <!-- Price & Action -->
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-blue-100 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Est. Price</p>
                        <h3 class="text-3xl font-black text-slate-800 tracking-tighter">RS <span id="priceTag">0</span></h3>
                    </div>
                    <button id="buyBtn" class="blue-grad text-white px-10 py-5 rounded-2xl font-black shadow-lg shadow-blue-200 hover:scale-105 active:scale-95 transition-all uppercase tracking-widest text-sm">Get Number</button>
                </div>
            </div>

            <!-- Right Side: Real-time Display (60%) -->
            <div class="lg:col-span-7">
                <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-blue-100 h-full flex flex-col min-h-[400px]">
                    <h3 class="text-sm font-black text-slate-400 uppercase mb-8 tracking-[0.2em] flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span> Result Console
                    </h3>
                    
                    <div id="resultArea" class="flex-1 flex flex-col items-center justify-center text-center">
                        <!-- Default State -->
                        <div id="waitingState" class="space-y-4">
                            <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto border border-slate-100">
                                <i class="fa-solid fa-satellite-dish text-3xl text-slate-200"></i>
                            </div>
                            <p class="text-slate-400 font-bold italic">Select a country and service to <br> initiate number generation.</p>
                        </div>

                        <!-- Active Number State (Hidden) -->
                        <div id="activeState" class="hidden w-full space-y-6">
                            <p class="text-xs font-black text-blue-600 uppercase tracking-widest">Number Successfully Allocated</p>
                            <h2 id="displayNum" class="text-5xl md:text-6xl font-black text-slate-800 tracking-tighter">---</h2>
                            
                            <div id="otpContainer" class="bg-blue-50 p-8 rounded-[2rem] border-2 border-dashed border-blue-200">
                                <p id="otpStatus" class="text-slate-400 font-black animate-pulse uppercase tracking-widest text-sm">Waiting for SMS Code...</p>
                                <h3 id="displayOtp" class="text-6xl font-black text-blue-700 mt-2 tracking-[0.5em]"></h3>
                            </div>

                            <div class="flex flex-wrap gap-4 justify-center">
                                <button onclick="location.reload()" class="bg-red-50 text-red-600 px-8 py-3 rounded-xl font-bold hover:bg-red-100 transition">Cancel Order</button>
                                <button id="copyBtn" class="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-800 transition">Copy Number</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="mt-10 bg-slate-900 text-green-400 p-6 rounded-3xl font-mono text-xs overflow-hidden shadow-2xl">
            <p class="mb-2 text-slate-500">// System Response Logs</p>
            <div id="sysLogs" class="h-20 overflow-y-auto space-y-1">
                > Console Ready...
            </div>
        </div>
    </div>

    <script>
        // API CONFIG
        const API_KEY = "e4c5d4fcc56363f572a597267b42e5d2";
        const PROXY = "https://corsproxy.io/?";
        const BASE_URL = "http://otpget.com/stubs/handler_api.php";

        const log = (msg) => {
            const div = document.getElementById('sysLogs');
            div.innerHTML += `<div>> ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        };

        async function apiFetch(params) {
            const url = `${BASE_URL}?api_key=${API_KEY}&${params}`;
            const response = await fetch(PROXY + encodeURIComponent(url));
            const text = await response.text();
            log(`API Request: ${params} | Response: ${text.substring(0, 50)}...`);
            return text;
        }

        // 1. Load Countries
        async function loadCountries() {
            try {
                const data = await apiFetch("action=getCountries");
                const select = document.getElementById('countrySelect');
                select.innerHTML = '<option value="">-- Select Server --</option>';
                
                data.split('|').forEach(item => {
                    const [id, name] = item.split(':');
                    if(id && name) {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.innerText = `${name} (Server ${id})`;
                        select.appendChild(opt);
                    }
                });
                log("Servers successfully synchronized.");
            } catch (e) {
                log("Error: Connection Failed.");
                document.getElementById('countrySelect').innerHTML = '<option>Failed to load servers</option>';
            }
        }

        // 2. Load Services
        document.getElementById('countrySelect').onchange = async (e) => {
            const countryId = e.target.value;
            if(!countryId) return;
            
            const sSelect = document.getElementById('serviceSelect');
            sSelect.innerHTML = '<option>ðŸ”„ Fetching stock...</option>';
            
            try {
                const data = await apiFetch(`action=getServices&country=${countryId}`);
                const services = JSON.parse(data);
                
                sSelect.innerHTML = '<option value="">-- Select Service --</option>';
                services.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.code;
                    // Markup: (Price * 5) + 20 PKR
                    const pkr = Math.ceil((s.price * 5) + 20);
                    opt.innerText = `${s.name.toUpperCase()} (Stock: ${s.count})`;
                    opt.dataset.price = pkr;
                    sSelect.appendChild(opt);
                });
            } catch (e) {
                sSelect.innerHTML = '<option>Error loading stock</option>';
            }
        };

        // Price Update
        document.getElementById('serviceSelect').onchange = (e) => {
            const price = e.target.selectedOptions[0]?.dataset.price || 0;
            document.getElementById('priceTag').innerText = price;
        };

        // 3. Buy Number
        document.getElementById('buyBtn').onclick = async () => {
            const c = document.getElementById('countrySelect').value;
            const s = document.getElementById('serviceSelect').value;
            if(!c || !s) return alert("Select server and service!");

            const btn = document.getElementById('buyBtn');
            btn.innerText = "ALLOCATING...";
            btn.disabled = true;

            try {
                const result = await apiFetch(`action=getNumber&country=${c}&service=${s}`);
                
                if (result.includes("ACCESS_NUMBER")) {
                    const [_, id, num] = result.split(':');
                    startActivationUI(num, id);
                } else {
                    alert("API Error: " + result);
                }
            } catch (e) {
                alert("Request Failed. Check Logs.");
            }
            btn.innerText = "Get Number";
            btn.disabled = false;
        };

        function startActivationUI(num, id) {
            document.getElementById('waitingState').classList.add('hidden');
            document.getElementById('activeState').classList.remove('hidden');
            document.getElementById('displayNum').innerText = num;
            
            document.getElementById('copyBtn').onclick = () => {
                navigator.clipboard.writeText(num);
                log("Number copied to clipboard.");
            };

            // Start OTP Polling
            let pollCount = 0;
            const timer = setInterval(async () => {
                pollCount++;
                const status = await apiFetch(`action=getStatus&id=${id}`);
                
                if(status.includes("STATUS_OK")) {
                    const code = status.split(':')[1];
                    document.getElementById('otpStatus').innerText = "OTP RECEIVED SUCCESSFULLY!";
                    document.getElementById('otpStatus').classList.remove('animate-pulse', 'text-slate-400');
                    document.getElementById('otpStatus').classList.add('text-green-500');
                    document.getElementById('displayOtp').innerText = code;
                    clearInterval(timer);
                    log(`Success: SMS Code ${code} received.`);
                }
                
                if(pollCount > 100) clearInterval(timer); // Stop after ~8 mins
            }, 5000);
        }

        // Init
        loadCountries();
    </script>
</body>
</html>
