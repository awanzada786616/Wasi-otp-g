<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTING MODE | Wasi OTP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .blue-grad { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 p-4 md:p-10">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-10 bg-white p-6 rounded-3xl shadow-sm border border-blue-100">
            <div>
                <h1 class="text-2xl font-black text-blue-700 uppercase">Testing <span class="text-slate-800">Panel</span></h1>
                <p class="text-xs font-bold text-red-500 uppercase tracking-widest mt-1">Firebase Login Bypassed (Testing Only)</p>
            </div>
            <div class="text-right">
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Test Balance</p>
                <p class="text-2xl font-black text-green-600">RS <span id="userBalance">5000.00</span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Side: Selection -->
            <div class="space-y-6">
                <!-- Country -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-100">
                    <label class="block text-xs font-black text-blue-700 uppercase mb-3">1. Select Server</label>
                    <select id="countrySelect" class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none focus:border-blue-600">
                        <option value="">Loading Countries...</option>
                    </select>
                </div>

                <!-- Service -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-100">
                    <label class="block text-xs font-black text-blue-700 uppercase mb-3">2. Select Service</label>
                    <select id="serviceSelect" class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl p-4 font-bold outline-none focus:border-blue-600">
                        <option value="">Choose Country First</option>
                    </select>
                </div>

                <!-- Price & Buy -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-blue-100 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Price</p>
                        <h3 class="text-2xl font-black text-slate-800 italic">RS <span id="priceDisplay">0</span></h3>
                    </div>
                    <button id="getNumberBtn" class="blue-grad text-white px-8 py-4 rounded-2xl font-black shadow-lg shadow-blue-200 active:scale-95 transition">GET NUMBER</button>
                </div>
            </div>

            <!-- Right Side: Display -->
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-blue-100 min-h-[300px] flex flex-col items-center justify-center">
                <h3 class="text-sm font-black text-slate-400 uppercase mb-6 tracking-widest">Result Area</h3>
                <div id="activeNumberDisplay" class="w-full text-center">
                    <div class="border-2 border-dashed border-gray-100 p-10 rounded-3xl">
                        <i class="fa-solid fa-tower-broadcast text-4xl text-blue-100 mb-4"></i>
                        <p class="text-slate-400 font-bold italic text-sm">Waiting for selection...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TESTING LOGIC -->
    <script>
        // --- 1. Load Countries ---
        async function loadCountries() {
            try {
                const response = await fetch('/.netlify/functions/api-bridge?action=getCountries');
                const data = await response.json();
                const countrySelect = document.getElementById('countrySelect');
                
                // netlify function sends back { message: "0:Russia|1:USA..." }
                let countries = data.message;
                countrySelect.innerHTML = '<option value="">-- Select Country --</option>';
                
                countries.split('|').forEach(item => {
                    let [id, name] = item.split(':');
                    if(id && name) {
                        let opt = document.createElement('option');
                        opt.value = id;
                        opt.innerText = name;
                        countrySelect.appendChild(opt);
                    }
                });
            } catch (err) {
                alert("CORS Error ya Function not found! Kya aapne 'netlify dev' chalaya hai?");
            }
        }

        // --- 2. Load Services ---
        document.getElementById('countrySelect').onchange = async (e) => {
            const countryId = e.target.value;
            if(!countryId) return;

            const serviceSelect = document.getElementById('serviceSelect');
            serviceSelect.innerHTML = '<option>Loading...</option>';

            try {
                const response = await fetch(`/.netlify/functions/api-bridge?action=getServices&country=${countryId}`);
                const data = await response.json();
                
                // Assuming services come back as JSON array in data.message
                let services = JSON.parse(data.message);
                serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';
                
                services.forEach(s => {
                    let opt = document.createElement('option');
                    opt.value = s.code;
                    let pkr = Math.ceil((s.price * 4) + 20); // Test Profit
                    opt.innerText = `${s.name.toUpperCase()} - RS ${pkr}`;
                    opt.dataset.price = pkr;
                    serviceSelect.appendChild(opt);
                });
            } catch (err) {
                serviceSelect.innerHTML = '<option>No services found</option>';
            }
        };

        // Price display
        document.getElementById('serviceSelect').onchange = (e) => {
            const price = e.target.selectedOptions[0].dataset.price || 0;
            document.getElementById('priceDisplay').innerText = price;
        };

        // --- 3. Get Number ---
        document.getElementById('getNumberBtn').onclick = async () => {
            const c = document.getElementById('countrySelect').value;
            const s = document.getElementById('serviceSelect').value;
            if(!c || !s) return alert("Select Both!");

            const btn = document.getElementById('getNumberBtn');
            btn.innerText = "Requesting...";
            btn.disabled = true;

            try {
                const res = await fetch(`/.netlify/functions/api-bridge?action=getNumber&country=${c}&service=${s}`);
                const data = await res.json();
                const msg = data.message; // ACCESS_NUMBER:ID:NUMBER

                if(msg.includes("ACCESS_NUMBER")) {
                    const [_, id, num] = msg.split(':');
                    showResult(num, id);
                } else {
                    alert("API Response: " + msg);
                }
            } catch (err) {
                alert("Error calling Netlify function.");
            } finally {
                btn.innerText = "GET NUMBER";
                btn.disabled = false;
            }
        };

        function showResult(num, id) {
            document.getElementById('activeNumberDisplay').innerHTML = `
                <div class="bg-blue-50 p-6 rounded-3xl border-2 border-blue-200">
                    <p class="text-xs font-bold text-blue-600 mb-2">NUMBER GENERATED</p>
                    <h2 class="text-3xl font-black mb-4">${num}</h2>
                    <div id="otpBox" class="bg-white p-4 rounded-2xl border-2 border-dashed border-blue-200">
                        <p class="animate-pulse text-slate-400">Waiting for OTP...</p>
                    </div>
                </div>
            `;
            // Yahan aap Polling ka code bhi dal sakte hain testing ke liye
        }

        // Start
        loadCountries();
    </script>
</body>
</html>